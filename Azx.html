<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apknixy Admin</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #eee; }
        .box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, button { padding: 12px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        .btn-green { background: #00C853; color: white; border: none; cursor: pointer; }
        .btn-red { background: #d32f2f; color: white; border: none; cursor: pointer; }
        .btn-blue { background: #2962FF; color: white; border: none; cursor: pointer; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #333; color: white; }
        
        .badge { padding: 5px 10px; border-radius: 5px; color: white; font-size: 12px; }
        .bg-pending { background: orange; }
        .bg-paid { background: green; }
        .bg-rejected { background: red; }
    </style>
</head>
<body>

    <h2>üëÆ Super Admin Panel</h2>
    
    <div id="login-section" class="box">
        <p>Login Authorized Personnel Only</p>
        <button class="btn-blue" onclick="adminLogin()">Login via Google</button>
    </div>

    <div id="admin-dashboard" class="box" style="display:none;">
        
        <h3>üîç Search User & Withdrawals</h3>
        <input type="text" id="searchInput" placeholder="Enter User Email or Name">
        <button class="btn-blue" onclick="searchData()">Search</button>

        <div id="userResult" style="margin-top:20px; display:none; border:1px solid #ccc; padding:15px; background:#f9f9f9;">
            <h4>üë§ User Details</h4>
            <p><b>Name:</b> <span id="uName"></span></p>
            <p><b>Email:</b> <span id="uEmail"></span></p>
            <p><b>UPI:</b> <span id="uUpi"></span></p>
            <p><b>Wallet Balance:</b> ‚Çπ<span id="uBal" style="font-weight:bold; color:green;"></span></p>
            <hr>
            <h4>üè¶ User's Withdrawal Requests</h4>
            <table id="uWithdrawTable">
                <thead>
                    <tr><th>Date</th><th>Amount</th><th>Status</th><th>Action</th></tr>
                </thead>
                <tbody id="uWithdrawList"></tbody>
            </table>
        </div>

        <hr style="margin: 30px 0;">

        <h3>‚ö° All Pending Requests (Global)</h3>
        <button onclick="loadPending()" style="width:auto; padding:5px 15px;">Refresh List</button>
        <table id="globalTable">
            <thead>
                <tr><th>User</th><th>UPI</th><th>Amount</th><th>Status</th><th>Actions</th></tr>
            </thead>
            <tbody id="globalList"></tbody>
        </table>

    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBXOBu6fmbco27_ugn9pFg2XQ-TaIeNRpY",
            authDomain: "apknixy-bc9ee.firebaseapp.com",
            projectId: "apknixy-bc9ee",
            storageBucket: "apknixy-bc9ee.firebasestorage.app",
            messagingSenderId: "99276264960",
            appId: "1:99276264960:web:a4f28913305288544e2ae5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        function adminLogin() {
            auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).then(res => {
                if(res.user.email === "apknixy@gmail.com") {
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('admin-dashboard').style.display = 'block';
                    loadPending();
                } else {
                    alert("Access Denied! Not Admin.");
                    auth.signOut();
                }
            });
        }

        // --- SEARCH LOGIC ---
        function searchData() {
            const query = document.getElementById('searchInput').value.trim();
            if(!query) return alert("Enter email to search");

            // 1. Find User by Email
            db.collection('users').where('email', '==', query).get().then(snap => {
                if(snap.empty) return alert("User not found!");
                
                const userDoc = snap.docs[0];
                const userData = userDoc.data();
                const userId = userDoc.id;

                // Show User Data
                document.getElementById('userResult').style.display = 'block';
                document.getElementById('uName').innerText = userData.name || "N/A";
                document.getElementById('uEmail').innerText = userData.email;
                document.getElementById('uUpi').innerText = userData.upi || "Not Set";
                document.getElementById('uBal').innerText = (userData.balance || 0).toFixed(2);

                // 2. Fetch Withdrawals for this User
                fetchUserWithdrawals(userId);
            });
        }

        function fetchUserWithdrawals(userId) {
            const list = document.getElementById('uWithdrawList');
            list.innerHTML = "";
            
            db.collection('withdrawals')
              .where('userId', '==', userId)
              .orderBy('date', 'desc')
              .get().then(snap => {
                  if(snap.empty) { list.innerHTML = "<tr><td colspan='4'>No requests found</td></tr>"; return; }
                  
                  snap.forEach(doc => {
                      const d = doc.data();
                      const row = `<tr>
                        <td>${new Date(d.date.seconds*1000).toLocaleDateString()}</td>
                        <td>‚Çπ${d.amount}</td>
                        <td><span class="badge bg-${d.status}">${d.status}</span></td>
                        <td>
                            ${d.status === 'pending' ? getActionButtons(doc.id) : 'Completed'}
                        </td>
                      </tr>`;
                      list.innerHTML += row;
                  });
              });
        }

        // --- GLOBAL LIST ---
        function loadPending() {
            const list = document.getElementById('globalList');
            list.innerHTML = "";
            
            db.collection('withdrawals')
              .where('status', '==', 'pending')
              .get().then(snap => {
                  snap.forEach(doc => {
                      const d = doc.data();
                      const row = `<tr>
                        <td>${d.email}<br><small>${d.name}</small></td>
                        <td>${d.upi}</td>
                        <td style="font-weight:bold">‚Çπ${d.amount}</td>
                        <td><span class="badge bg-pending">Pending</span></td>
                        <td>${getActionButtons(doc.id)}</td>
                      </tr>`;
                      list.innerHTML += row;
                  });
              });
        }

        // --- ACTION BUTTONS HTML ---
        function getActionButtons(docId) {
            return `
                <button onclick="updateStatus('${docId}', 'paid')" class="btn-green" style="width:auto; padding:5px;">‚úÖ Paid</button>
                <button onclick="updateStatus('${docId}', 'rejected')" class="btn-red" style="width:auto; padding:5px;">‚ùå Reject</button>
            `;
        }

        // --- UPDATE STATUS LOGIC ---
        function updateStatus(docId, newStatus) {
            if(confirm(`Mark this request as ${newStatus.toUpperCase()}?`)) {
                db.collection('withdrawals').doc(docId).update({
                    status: newStatus
                }).then(() => {
                    alert("Status Updated!");
                    // Refresh data
                    loadPending();
                    const searchVal = document.getElementById('searchInput').value;
                    if(searchVal) searchData(); 
                });
            }
        }
    </script>
</body>
</html>
