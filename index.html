<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <title>Apknixy Task</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #0f172a; --accent: #22c55e; --bg: #f8fafc; --white: #ffffff; --text: #334155; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text); }
        .hidden { display: none !important; }
        
        /* HEADER */
        .navbar { background: var(--white); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 50; }
        
        /* CSS LOGO */
        .brand-logo { font-size: 20px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; text-transform: uppercase; }
        .brand-logo span { color: var(--accent); }
        
        /* HAMBURGER MENU ICON (CSS ONLY) */
        .menu-icon { width: 24px; height: 18px; position: relative; cursor: pointer; }
        .menu-icon span { display: block; position: absolute; height: 2px; width: 100%; background: var(--primary); border-radius: 2px; transition: .25s ease-in-out; }
        .menu-icon span:nth-child(1) { top: 0; }
        .menu-icon span:nth-child(2) { top: 8px; }
        .menu-icon span:nth-child(3) { top: 16px; }

        /* DRAWER */
        .sidebar { position: fixed; top: 0; right: -280px; width: 260px; height: 100%; background: var(--white); z-index: 100; transition: 0.3s; padding: 30px; box-shadow: -5px 0 20px rgba(0,0,0,0.05); }
        .sidebar.active { right: 0; }
        .nav-link { display: block; padding: 12px 0; font-weight: 600; color: var(--text); border-bottom: 1px solid #f1f5f9; cursor: pointer; }
        .nav-link:hover { color: var(--accent); }
        .close-btn { text-align: right; font-weight: 800; cursor: pointer; margin-bottom: 30px; color: #ef4444; }

        /* CONTAINER */
        .main-container { max-width: 500px; margin: 0 auto; padding: 20px; }

        /* BALANCE CARD */
        .stats-card { background: var(--primary); color: var(--white); padding: 30px; border-radius: 16px; text-align: center; margin-bottom: 25px; box-shadow: 0 10px 25px -5px rgba(15, 23, 42, 0.3); }
        .stats-label { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; }
        .stats-value { font-size: 42px; font-weight: 800; margin: 10px 0; }

        /* BUTTONS */
        .btn { display: block; width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: 600; font-size: 15px; cursor: pointer; transition: 0.2s; margin-bottom: 12px; }
        .btn-accent { background: var(--accent); color: var(--white); box-shadow: 0 4px 6px -1px rgba(34, 197, 94, 0.4); }
        .btn-dark { background: #334155; color: var(--white); }
        .btn-outline { background: transparent; border: 2px solid #cbd5e1; color: #64748b; }

        /* AD GRID SYSTEM (20 Banners) */
        .ad-grid { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; }
        .ad-slot { background: #e2e8f0; min-height: 250px; display: flex; align-items: center; justify-content: center; border-radius: 8px; overflow: hidden; position: relative; }
        .ad-slot::before { content: 'ADVERTISEMENT'; position: absolute; font-size: 10px; color: #94a3b8; font-weight: bold; letter-spacing: 1px; }
        
        /* FORMS */
        .input-group { margin-bottom: 15px; }
        .form-input { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 10px; font-family: inherit; box-sizing: border-box; }
        .form-input:focus { border-color: var(--primary); outline: none; }

        /* HISTORY LIST */
        .list-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        .tag { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 800; text-transform: uppercase; }
        .tag-pending { background: #fff7ed; color: #c2410c; }
        .tag-paid { background: #f0fdf4; color: #15803d; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="brand-logo">Apknixy<span>Task</span></div>
        <div class="menu-icon" onclick="toggleMenu()">
            <span></span><span></span><span></span>
        </div>
    </nav>

    <div class="sidebar" id="sidebar">
        <div class="close-btn" onclick="toggleMenu()">CLOSE</div>
        <div class="nav-link" onclick="switchTab('withdraw')">Withdraw Funds</div>
        <div class="nav-link" onclick="switchTab('history')">Transaction History</div>
        <div class="nav-link" onclick="logout()" style="color:#ef4444; border:none;">Sign Out</div>
    </div>

    <div class="main-container">

        <div id="auth-screen" style="text-align:center; margin-top:100px;">
            <h2 style="color:var(--primary);">Welcome Back</h2>
            <p style="color:#64748b; margin-bottom:30px;">Sign in to access your dashboard.</p>
            <button class="btn btn-dark" onclick="googleSignIn()">Continue with Google</button>
        </div>

        <div id="dash-screen" class="hidden">
            <div class="stats-card">
                <div class="stats-label">Total Earnings</div>
                <div class="stats-value">â‚¹<span id="bal">0.00</span></div>
            </div>

            <button class="btn btn-accent" onclick="openTimeWall()">START TASKS (TimeWall)</button>
            <button class="btn btn-dark" onclick="openSmartLink()">INSTALL APPS</button>

            <div class="ad-grid">
                <div class="ad-slot"><script>(function(odwi){var d=document,s=d.createElement('script'),l=d.scripts[d.scripts.length-1];s.settings=odwi||{};s.src="\/\/swiftvolume.com\/byXaVCsWd.GZlE0iYuWbcT\/YeVmm9suUZVUglKk\/P\/TIYz3uM\/zLgSxqMCTEYxt-NGjdcOz\/OpDcENxvNewl";s.async=true;s.referrerPolicy='no-referrer-when-downgrade';l.parentNode.insertBefore(s,l);})({})</script></div>
                <div class="ad-slot"><script>(function(odwi){var d=document,s=d.createElement('script'),l=d.scripts[d.scripts.length-1];s.settings=odwi||{};s.src="\/\/swiftvolume.com\/byXaVCsWd.GZlE0iYuWbcT\/YeVmm9suUZVUglKk\/P\/TIYz3uM\/zLgSxqMCTEYxt-NGjdcOz\/OpDcENxvNewl";s.async=true;s.referrerPolicy='no-referrer-when-downgrade';l.parentNode.insertBefore(s,l);})({})</script></div>
                <div class="ad-slot"><script>(function(odwi){var d=document,s=d.createElement('script'),l=d.scripts[d.scripts.length-1];s.settings=odwi||{};s.src="\/\/swiftvolume.com\/byXaVCsWd.GZlE0iYuWbcT\/YeVmm9suUZVUglKk\/P\/TIYz3uM\/zLgSxqMCTEYxt-NGjdcOz\/OpDcENxvNewl";s.async=true;s.referrerPolicy='no-referrer-when-downgrade';l.parentNode.insertBefore(s,l);})({})</script></div>
                <div class="ad-slot"><script>(function(odwi){var d=document,s=d.createElement('script'),l=d.scripts[d.scripts.length-1];s.settings=odwi||{};s.src="\/\/swiftvolume.com\/byXaVCsWd.GZlE0iYuWbcT\/YeVmm9suUZVUglKk\/P\/TIYz3uM\/zLgSxqMCTEYxt-NGjdcOz\/OpDcENxvNewl";s.async=true;s.referrerPolicy='no-referrer-when-downgrade';l.parentNode.insertBefore(s,l);})({})</script></div>
                <div class="ad-slot"><script>(function(odwi){var d=document,s=d.createElement('script'),l=d.scripts[d.scripts.length-1];s.settings=odwi||{};s.src="\/\/swiftvolume.com\/byXaVCsWd.GZlE0iYuWbcT\/YeVmm9suUZVUglKk\/P\/TIYz3uM\/zLgSxqMCTEYxt-NGjdcOz\/OpDcENxvNewl";s.async=true;s.referrerPolicy='no-referrer-when-downgrade';l.parentNode.insertBefore(s,l);})({})</script></div>
                
                <script>
                (function(tqr){var d=document,s=d.createElement('script'),l=d.scripts[d.scripts.length-1];s.settings=tqr||{};s.src="\/\/swiftvolume.com\/bjX.VcsXdeGPlr0lY\/Wxcl\/seDmO9CuhZwU\/lukLP\/TYYP3nMJzCgAxLM\/TqIGtUNOjTcszPONDVEwxEMdwd";s.async=true;s.referrerPolicy='no-referrer-when-downgrade';l.parentNode.insertBefore(s,l);})({})
                </script>
            </div>
        </div>

        <div id="withdraw-screen" class="hidden">
            <h3 style="color:var(--primary);">Withdraw Funds</h3>
            <div style="background:#f1f5f9; padding:15px; border-radius:8px; font-size:13px; margin-bottom:20px; color:#475569;">
                Payouts are processed within 0-7 business days. Delayed payments will be cleared in the subsequent 7-14 day cycle.
            </div>

            <p>Target UPI: <b><span id="upi-display" style="color:var(--accent);">Not Configured</span></b></p>
            
            <input type="text" id="upi-field" class="form-input" placeholder="Enter UPI ID" style="display:none; margin-bottom:10px;">
            <button class="btn btn-dark" id="upi-save-btn" onclick="updateUpi()" style="display:none;">Save Configuration</button>

            <div class="input-group">
                <input type="number" id="amt-field" class="form-input" placeholder="Amount (INR) - Min 200">
            </div>
            
            <button class="btn btn-accent" onclick="processWithdraw()">Confirm Withdraw</button>
            <button class="btn btn-outline" onclick="switchTab('dash')">Cancel</button>

            <div id="hist-list" style="margin-top:30px;"></div>
        </div>

    </div>

    <div id="tw-container" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; z-index:200;">
        <div style="background:var(--primary); color:#fff; padding:15px; display:flex; justify-content:space-between;">
            <span>TimeWall</span>
            <span onclick="closeTimeWall()" style="cursor:pointer;">CLOSE</span>
        </div>
        <iframe id="tw-view" style="width:100%; height:100%; border:none;"></iframe>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBXOBu6fmbco27_ugn9pFg2XQ-TaIeNRpY",
            authDomain: "apknixy-bc9ee.firebaseapp.com",
            projectId: "apknixy-bc9ee",
            storageBucket: "apknixy-bc9ee.firebasestorage.app",
            messagingSenderId: "99276264960",
            appId: "1:99276264960:web:a4f28913305288544e2ae5"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let user = null;

        auth.onAuthStateChanged(u => {
            if (u) { user = u; switchTab('dash'); syncData(); } 
            else { switchTab('auth'); }
        });

        function googleSignIn() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(console.error); }
        function logout() { auth.signOut(); location.reload(); }
        function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); }

        function switchTab(tab) {
            ['auth', 'dash', 'withdraw'].forEach(t => document.getElementById(t + '-screen').classList.add('hidden'));
            document.getElementById('sidebar').classList.remove('active');
            
            if (tab === 'history') {
                document.getElementById('withdraw-screen').classList.remove('hidden');
                fetchHistory();
            } else {
                document.getElementById(tab + '-screen').classList.remove('hidden');
                if (tab === 'withdraw') fetchHistory();
            }
        }

        function syncData() {
            db.collection('users').doc(user.uid).onSnapshot(doc => {
                if (doc.exists) {
                    const d = doc.data();
                    document.getElementById('bal').innerText = (d.balance || 0).toFixed(2);
                    if (d.upi) {
                        document.getElementById('upi-display').innerText = d.upi;
                        document.getElementById('upi-field').style.display = 'none';
                        document.getElementById('upi-save-btn').style.display = 'none';
                    } else {
                        document.getElementById('upi-field').style.display = 'block';
                        document.getElementById('upi-save-btn').style.display = 'block';
                    }
                }
            });
        }

        function updateUpi() {
            const val = document.getElementById('upi-field').value;
            if (val) db.collection('users').doc(user.uid).set({ upi: val, email: user.email }, { merge: true });
        }

        function openSmartLink() {
            // Updated Smart Link Logic with UID
            window.open(`https://www.lisabergtrain.support/click?offer_id=32308&pub_id=267394&pub_click_id=${user.uid}&site=apknixy`, '_blank');
        }

        function openTimeWall() {
            // Paste your Deployment URL here (Check TimeWall Dashboard)
            const url = "https://timewall.io/wall/YOUR_PLACEMENT_ID?userid=" + user.uid;
            
            // Check if user forgot to add link
            if(url.includes("YOUR_PLACEMENT")) { alert("Add TimeWall Link in code first"); return; }
            
            document.getElementById('tw-view').src = url;
            document.getElementById('tw-container').style.display = 'block';
        }

        function closeTimeWall() {
            document.getElementById('tw-container').style.display = 'none';
            document.getElementById('tw-view').src = "";
        }

        function processWithdraw() {
            const amt = parseFloat(document.getElementById('amt-field').value);
            const bal = parseFloat(document.getElementById('bal').innerText);
            const upi = document.getElementById('upi-display').innerText;

            if (amt < 200) return alert("Minimum withdrawal: 200 INR");
            if (amt > bal) return alert("Insufficient funds");
            if (upi === "Not Configured") return alert("Configure UPI first");

            if (confirm("Confirm withdrawal?")) {
                db.collection('users').doc(user.uid).update({
                    balance: firebase.firestore.FieldValue.increment(-amt)
                }).then(() => {
                    db.collection('withdrawals').add({
                        userId: user.uid, email: user.email, upi: upi,
                        amount: amt, status: 'pending', date: new Date()
                    });
                    alert("Request Submitted.");
                    document.getElementById('amt-field').value = "";
                    fetchHistory();
                });
            }
        }

        function fetchHistory() {
            const list = document.getElementById('hist-list');
            list.innerHTML = "Loading...";
            db.collection('withdrawals').where("userId", "==", user.uid).orderBy("date", "desc").limit(10).get().then(snap => {
                list.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    const statusClass = d.status === 'paid' ? 'tag-paid' : (d.status === 'rejected' ? 'tag-rejected' : 'tag-pending');
                    list.innerHTML += `
                        <div class="list-item">
                            <div>
                                <div style="font-weight:600;">INR ${d.amount}</div>
                                <div style="font-size:11px; color:#94a3b8;">${new Date(d.date.seconds*1000).toLocaleDateString()}</div>
                            </div>
                            <div class="tag ${statusClass}">${d.status}</div>
                        </div>
                    `;
                });
            });
        }
    </script>
</body>
</html>
