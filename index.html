<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <title>Apknixy - Earn & Watch</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background: #f0f2f5; margin: 0; padding: 0; color: #333; }
        .container { max-width: 480px; margin: 0 auto; padding: 20px; padding-bottom: 80px; }
        .hidden { display: none !important; }
        
        /* HEADER */
        .header { background: #00C853; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .logo { font-size: 20px; font-weight: bold; }
        
        /* CARDS */
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .wallet-bg { background: linear-gradient(135deg, #00C853 0%, #009624 100%); color: white; text-align: center; }
        .balance { font-size: 48px; font-weight: bold; margin: 10px 0; }
        
        /* BUTTONS */
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: #2962FF; color: white; }
        .btn-success { background: #00C853; color: white; }
        .btn-danger { background: white; color: #d32f2f; border: 1px solid #d32f2f; }
        
        /* ADS AREA */
        .ad-box { margin: 20px 0; text-align: center; overflow: hidden; }
        .vast-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .vast-player { background: #000; height: 120px; border-radius: 8px; position: relative; display: flex; align-items: center; justify-content: center; color: #555; overflow: hidden; }
        .vast-player video { width: 100%; height: 100%; object-fit: cover; }
        
        /* HISTORY TABLE */
        .history-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        .status-pending { color: orange; font-weight: bold; }
        .status-paid { color: green; font-weight: bold; }
        .status-rejected { color: red; font-weight: bold; }

        .payment-notice { background: #fff3cd; color: #856404; padding: 15px; border-radius: 10px; font-size: 13px; margin-bottom: 20px; border-left: 5px solid #ffc107; }
        
        /* MENU */
        .drawer { position: fixed; top: 0; right: -100%; width: 250px; height: 100%; background: white; z-index: 1000; transition: 0.3s; padding: 20px; box-shadow: -5px 0 15px rgba(0,0,0,0.1); }
        .drawer.open { right: 0; }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">Apknixy</div>
        <div onclick="toggleDrawer()" style="font-size:24px; cursor:pointer;">‚ò∞</div>
    </div>

    <div id="drawer" class="drawer">
        <div onclick="toggleDrawer()" style="text-align:right; color:red; font-weight:bold; cursor:pointer; margin-bottom:20px;">‚úñ CLOSE</div>
        <p onclick="showSection('withdraw')">üí∏ Withdraw Money</p>
        <p onclick="showSection('history')">üìú Payment History</p>
        <p onclick="logout()" style="color:red; margin-top:20px;">üö™ Logout</p>
    </div>

    <div class="container">
        
        <div id="login-view" style="text-align:center; margin-top:100px;">
            <h2>Start Earning</h2>
            <button class="btn btn-primary" onclick="googleLogin()">Login with Google</button>
        </div>

        <div id="dashboard-view" class="hidden">
            <div class="card wallet-bg">
                <div>Current Balance</div>
                <div class="balance">‚Çπ<span id="userBalance">0</span></div>
                <button class="btn btn-danger" onclick="openSmartLink()">üì≤ INSTALL & EARN</button>
            </div>

            <div class="ad-box">
                <script>
                (function(odwi){
                var d = document, s = d.createElement('script'), l = d.scripts[d.scripts.length - 1];
                s.settings = odwi || {};
                s.src = "\/\/swiftvolume.com\/byXaVCsWd.GZlE0iYuWbcT\/YeVmm9suUZVUglKk\/P\/TIYz3uM\/zLgSxqMCTEYxt-NGjdcOz\/OpDcENxvNewl";
                s.async = true; s.referrerPolicy = 'no-referrer-when-downgrade';
                l.parentNode.insertBefore(s, l);
                })({})
                </script>
            </div>

            <div class="ad-box">
                <script>
                (function(rbtsgm){
                var d = document, s = d.createElement('script'), l = d.scripts[d.scripts.length - 1];
                s.settings = rbtsgm || {};
                s.src = "\/\/swiftvolume.com\/bOXaV.sRdPGZlZ0lY\/Wxcx\/de\/mV9lu\/ZIUKl-kxPDTnYZ3WMgzcguxJMCjjAQtkNwjmcVzAOCDOEZyhM\/QT";
                s.async = true; s.referrerPolicy = 'no-referrer-when-downgrade';
                l.parentNode.insertBefore(s, l);
                })({})
                </script>
            </div>

            <h3>üì∫ Sponsored Videos</h3>
            <div class="vast-grid">
                <div class="vast-player" id="player1">Loading Ad 1...</div>
                <div class="vast-player" id="player2">Loading Ad 2...</div>
                <div class="vast-player" id="player3">Loading Ad 3...</div>
                <div class="vast-player" id="player4">Loading Ad 4...</div>
            </div>
            <p style="text-align:center; font-size:10px; color:#999;">Ads auto-rotate for maximum revenue.</p>
        </div>

        <div id="withdraw-view" class="hidden">
            <div class="card">
                <h3>Withdraw Money</h3>
                <div class="payment-notice">
                    ‚ÑπÔ∏è <b>Payment Policy:</b> Money will be transferred within <b>0-7 days</b>. If not received, it will be processed in the next <b>7-14 day</b> cycle in bulk.
                </div>
                
                <p>Withdraw to: <b><span id="dispUpi" style="color:#00C853">Not Set</span></b></p>
                <input type="text" id="upiInput" placeholder="Set UPI ID (First Time)" class="btn" style="background:#f9f9f9; border:1px solid #ddd; display:none;">
                <button class="btn btn-primary" id="saveUpiBtn" onclick="saveUpi()" style="display:none;">Save UPI</button>

                <input type="number" id="wAmount" placeholder="Enter Amount (Min ‚Çπ200)" class="btn" style="background:#fff; border:1px solid #ccc; text-align:left;">
                <button class="btn btn-success" onclick="requestWithdraw()">Withdraw Now</button>
                <button class="btn btn-danger" onclick="showSection('dashboard')">Cancel</button>
            </div>

            <h3>üìú Withdrawal History</h3>
            <div class="card" id="historyList">
                <p style="text-align:center;">Loading history...</p>
            </div>
        </div>

    </div>

    <script>
    (function(tqr){
    var d = document, s = d.createElement('script'), l = d.scripts[d.scripts.length - 1];
    s.settings = tqr || {};
    s.src = "\/\/swiftvolume.com\/bjX.VcsXdeGPlr0lY\/Wxcl\/seDmO9CuhZwU\/lukLP\/TYYP3nMJzCgAxLM\/TqIGtUNOjTcszPONDVEwxEMdwd";
    s.async = true; s.referrerPolicy = 'no-referrer-when-downgrade';
    l.parentNode.insertBefore(s, l);
    })({})
    </script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBXOBu6fmbco27_ugn9pFg2XQ-TaIeNRpY",
            authDomain: "apknixy-bc9ee.firebaseapp.com",
            projectId: "apknixy-bc9ee",
            storageBucket: "apknixy-bc9ee.firebasestorage.app",
            messagingSenderId: "99276264960",
            appId: "1:99276264960:web:a4f28913305288544e2ae5"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;

        // AUTH & INIT
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                showSection('dashboard');
                loadData();
                startVastCycle(); // Start VAST ads
            } else {
                showSection('login');
            }
        });

        function googleLogin() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(alert); }
        function logout() { auth.signOut(); location.reload(); }
        function toggleDrawer() { document.getElementById('drawer').classList.toggle('open'); }

        function showSection(id) {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('withdraw-view').classList.add('hidden');
            document.getElementById('drawer').classList.remove('open');
            
            if(id === 'history') id = 'withdraw'; // Show history in withdraw section
            document.getElementById(id + '-view').classList.remove('hidden');

            if(id === 'withdraw') loadHistory();
        }

        // DATA & SMART LINK
        function loadData() {
            db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
                if(doc.exists) {
                    const d = doc.data();
                    document.getElementById('userBalance').innerText = (d.balance || 0).toFixed(2);
                    if(d.upi) {
                        document.getElementById('dispUpi').innerText = d.upi;
                        document.getElementById('upiInput').style.display = 'none';
                        document.getElementById('saveUpiBtn').style.display = 'none';
                    } else {
                        document.getElementById('upiInput').style.display = 'block';
                        document.getElementById('saveUpiBtn').style.display = 'block';
                    }
                }
            });
        }

        function saveUpi() {
            const upi = document.getElementById('upiInput').value;
            if(!upi) return alert("Enter UPI ID");
            db.collection('users').doc(currentUser.uid).set({ 
                upi: upi, email: currentUser.email, name: currentUser.displayName 
            }, { merge: true }).then(() => alert("UPI Saved"));
        }

        function openSmartLink() {
            const baseUrl = "https://www.overthegridge.help/?sl=6045944-36e1f";
            const finalUrl = `${baseUrl}&pub_click_id=${currentUser.uid}`;
            window.open(finalUrl, '_blank');
        }

        // WITHDRAWAL LOGIC
        function requestWithdraw() {
            const amount = parseFloat(document.getElementById('wAmount').value);
            const currentBal = parseFloat(document.getElementById('userBalance').innerText);
            
            if(amount < 200) return alert("Minimum withdrawal is ‚Çπ200");
            if(amount > currentBal) return alert("Insufficient Balance");
            
            const upiText = document.getElementById('dispUpi').innerText;
            if(upiText === "Not Set") return alert("Please set UPI ID first");

            if(confirm(`Withdraw ‚Çπ${amount}? It will be deducted from your balance.`)) {
                // 1. Deduct Balance
                db.collection('users').doc(currentUser.uid).update({
                    balance: firebase.firestore.FieldValue.increment(-amount)
                }).then(() => {
                    // 2. Create Request
                    db.collection('withdrawals').add({
                        userId: currentUser.uid,
                        email: currentUser.email,
                        name: currentUser.displayName,
                        upi: upiText,
                        amount: amount,
                        status: 'pending',
                        date: new Date()
                    }).then(() => {
                        alert("Withdrawal Successful! Check history.");
                        document.getElementById('wAmount').value = "";
                        loadHistory();
                    });
                }).catch(err => alert("Error: " + err.message));
            }
        }

        function loadHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = "<p>Loading...</p>";
            
            db.collection('withdrawals')
              .where("userId", "==", currentUser.uid)
              .orderBy("date", "desc")
              .limit(10)
              .get().then(snap => {
                list.innerHTML = "";
                if(snap.empty) { list.innerHTML = "<p>No history found.</p>"; return; }
                
                snap.forEach(doc => {
                    const d = doc.data();
                    let colorClass = "";
                    if(d.status === 'pending') colorClass = "status-pending";
                    else if(d.status === 'paid') colorClass = "status-paid";
                    else colorClass = "status-rejected";

                    const row = `
                        <div class="history-item">
                            <div>
                                <b>‚Çπ${d.amount}</b><br>
                                <small>${new Date(d.date.seconds*1000).toLocaleDateString()}</small>
                            </div>
                            <div class="${colorClass}">
                                ${d.status.toUpperCase()}
                            </div>
                        </div>
                    `;
                    list.innerHTML += row;
                });
            });
        }

        // VAST ADS SIMULATION (Rotating Players)
        // Since VAST XML needs a parser, we will iframe the URL user gave or cycle logic
        function startVastCycle() {
            const vastUrl = "https://physicaldad.com/ddm.F/zjdPGpNhvqZ/GBUa/IezmO9hulZiUxldk/PVTwYt3JMNz/gJxDMMjmM/taNsjzcVzdOpDlEJyTNGCmZ-saaHWb1FpZdkDh0kxW";
            const players = ['player1', 'player2', 'player3', 'player4'];
            let active = 0;

            setInterval(() => {
                // Logic: Load VAST in one iframe, clear others
                // NOTE: Raw VAST XML needs a player like JWPlayer/IMA. 
                // Here we simply load the URL assuming it might redirect to media, 
                // or we act as placeholders for the Hilltop scripts.
                
                // Visual simulation of cycling
                document.getElementById(players[active]).style.border = "2px solid #00C853";
                document.getElementById(players[active]).innerHTML = `<iframe src="${vastUrl}" width="100%" height="100%" frameborder="0"></iframe>`;
                
                // Clear previous
                let prev = active === 0 ? 3 : active - 1;
                document.getElementById(players[prev]).style.border = "none";
                document.getElementById(players[prev]).innerHTML = "Ad Loading...";
                
                active = (active + 1) % 4;
            }, 5000); // Change every 5 seconds
        }
    </script>
</body>
</html>
